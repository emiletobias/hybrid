/**
 * Tencent is pleased to support the open source community by making VasSonic available.
 * Copyright (C) 2017 THL A29 Limited, a Tencent company. All rights reserved.
 * Licensed under the BSD 3-Clause License (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at https://opensource.org/licenses/BSD-3-Clause
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
 */

const crypto = require('crypto');

/*const edge = require('./node_modules/edge');

var helloWorld = edge.func(`
	using System.Text.RegularExpressions;


    async (inputStr) => { 
    	public static Regex regex = new Regex(
	      "<(?<HtmlTag>[\\w]+)[^>]*\\sclass=\\\"cms-component[^>]*?(/>|"+
	      ">((?<Nested><\\k<HtmlTag>[^>]*>)|</\\k<HtmlTag>>(?<-Nested>)"+
	      "|.*?)*</\\k<HtmlTag>>)",
	    RegexOptions.IgnoreCase
	    | RegexOptions.CultureInvariant
	    | RegexOptions.IgnorePatternWhitespace
	    | RegexOptions.Compiled
	    | RegexOptions.SingleLine
	    );

	    static string CustomReplace(System.Text.RegularExpressions.Match m) 
		{ 
		    return m.Groups[1].Value; //直接返回分组1
		}

		System.Text.RegularExpressions.MatchEvaluator myEvaluator = new System.Text.RegularExpressions.MatchEvaluator(CustomReplace); 

        return regex.Replace(inputStr,myEvaluator);; 
    }
`);

helloWorld('JavaScript', function (error, result) {
    if (error) throw error;
    console.log(result);
});*/

module.exports = function (req, res, buffer) {
	let etag = req.get('if-none-match');
	let now = Date.now();
	let md5 = crypto.createHash('sha1').update(buffer).digest('hex');

	console.info(`请求头etag = ${etag}`);
	console.info(`页面md5 = ${md5}`);

	//sonicMode含义
	// 0-非sonic（没有sonicdiff标签）
	// 1-首次加载（本地无模板和数据）
	// 2-页面刷新（模板有变）
	// 3-局部数据刷新（模板不变，数据有变）
	// 4-完成缓存304（模板不变，数据不变）
	if (etag && md5 == etag) {
		res.set('Cache-Offline', 'store');
		res.set('Content-Length', 0);
		res.statusCode = 304;
		res.sonicMode = 4;
		return {
			cache: true
		}
	} else {
		let htmlStr = buffer.toString('utf8');
		//替换 &&提取　title，body
		let title = "";

		let now2 = Date.now();
		let templateHtml = htmlStr.replace(/<title(.*?)<\/title>/i, function (titleHtml) {
			title = titleHtml;
			return "{title}";
		});
		//判断是否成功替换wnsdiffbody
		let flag = false;

		let tagIndex = 0, tagPrefix = 'hybrid_landingPage';

		let diffTagNames = {};


		/*let template_regx = /(?s)<(?<HtmlTag>[\w]+)[^>]*\sclass=\"cms-component[^>]*?(/>|>((?<Nested><\k<HtmlTag>[^>]*>)|</\k<HtmlTag>>(?<-Nested>)|.*?)*</\k<HtmlTag>>)/;*/

		/**/

		templateHtml = templateHtml.replace(/<!--hybriddiff-?(\w*)-->([\s\S]+?)<!--hybriddiff-?(\w*)-end-->/ig , function (diffhtml, tagName) {
			flag = true;
			if (!tagName) {
				tagName = tagPrefix + tagIndex++;
			}

			diffTagNames[tagName] = diffhtml;

			return '{' + tagName + '}';
		});

		console.info(`获取template diff耗时${Date.now() - now2}`);

		let now3 = Date.now();

		let templateMd5 = crypto.createHash('sha1').update(new Buffer(templateHtml)).digest('hex');

		console.info(`获取template md5耗时${Date.now() - now3}`);

		res.set('Etag', md5);
		res.set('template-tag', templateMd5);

		res.set('Cache-Offline', true);

		if (flag) {
			let templateTag = req.get('template-tag');

			if (templateMd5 == templateTag) {
				res.set('template-change', 'false');

				let result = {
					'data': {
						'{title}': title
					},
					'diff': '',
					'html-sha1': md5,
					"template-tag": templateMd5
				};

				Object.keys(diffTagNames).forEach(v => {
					result['data']['{' + v + '}'] = diffTagNames[v];
				});

				console.info(`数据更新耗时${Date.now() - now}`);

				res.sonicMode = 3;

				return {
					data: new Buffer(JSON.stringify(result))
				}

			} else {
				res.set('template-change', 'true');

				res.sonicMode = templateTag ? 2 : 1;

				console.info(`模版更新耗时${Date.now() - now}`);

				return {
					data: new Buffer(htmlStr)
				}
			}

		} else {

			res.set('template-change', 'true');

			res.sonicMode = 0;

			return {
				data: new Buffer(htmlStr)
			}
		}
	}
};
